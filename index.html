<!DOCTYPE Html>
    <html>
    <head>
        <title>Suite cours - HTTP request</title>
        <meta charset="utf-8">
        <style>
            .contenu{
                padding: 2px;
            }
        </style>
    </head>

    <body>
        <h1>HTTP request</h1>

        <hr>

        <!-- <p>Informations : <br>
        </p>
        <ul>
            <li>On récupère un fichier .xml grâce à une requête HTTP.</li>
            <li>L'objectif est d'afficher le contenu de l'xml dans la page appelante.</li>
            <li>En utilisant la variable xhttp</li>
            <li>Pour créer un objet XMLHttpRequest : "var xhttp = new XMLHttpRequest();"</li>
            <li>La propriété readyState contient le statut de l’objet xhttp créé</li>
            <li>L’événement onreadystatechange est déclenché chaque fois que readyState change</li>
            <li>Lors d'une demande de serveur, le readyState passe de 0 à 4:
                <ul>
                    <li>0: demande non initialisée</li>
                    <li>1: connexion au serveur établie</li>
                    <li>2: demande reçue</li>
                    <li>3: demande de traitement</li>
                    <li>4: demander fini et la réponse est prête</li>
                </ul>
            </li>
            <li>Statut 200 : OK ; Statut 404 : ressource non trouvée.</li>
            <li>La méthode open (sans argument pour un GET).</li>
            <li>La méthode GET est plus simple que POST et utilisable dans la plupart des cas.</li>
            <li>L'URL - un fichier sur un serveur</li>
            <li>les pages html et les fichiers web doivent être sur le même serveur.</li>
            <li>Le dernier paramètre permet de définir si async ou non (executer des taches de fond, ne pas attendre de réponse du serveur)</li>
        </ul> -->

        <h2>XML request</h2>

        <!-- conteneur qui recevra le résultat de la requête -->
        <div id="conteneur"></div>

        <!-- bouton qui lance la méthode de chargement du xml -->
        <button onclick="GetXML();">Lancement du changement du xml à distance</button>

        <!-- bouton qui lance la méthode de chargement du xml -->
        <button onclick="getEasyXML();">Lancement du changement du xml local</button>

        <br><br>

        <div style="display:flex; flex-direction: row;">
            <div class="contenu">
                <h3>XML</h3>
                <TEXTAREA id="areaXML"  rows="20" cols="50"></TEXTAREA>
            </div>
            <div class="contenu">
                <h3>Titres</h3>
                <TEXTAREA id="areaTitres"  rows="20" cols="50"></TEXTAREA>
            </div>
            <div class="contenu">   
                <h3>Realisateurs</h3>
                <TEXTAREA id="areaReals"  rows="20" cols="50"></TEXTAREA>
            </div>        
           <div class="contenu">
                <h3>Dates</h3>
                <TEXTAREA id="areaDates"  rows="20" cols="50"></TEXTAREA>
           </div>
        </div>
            
        <script type="text/javascript">
        
        var string = "<?xml version='1.0'?><films><film idfilm='1'><titre>The rider</titre><realisateur>Chloe Zhao</realisateur><date>2017</date></film><film idfilm='2'><titre>Mon Voisin Totoro</titre><realisateur>Ghibli</realisateur><date>1988</date></film><film idfilm='3'><titre>La princesse Mononoké</titre><realisateur>Ghibli</realisateur><date>1997</date></film><film idfilm='4'><titre>Toy Story</titre><realisateur>Pixar</realisateur><date>1995</date></film><film idfilm='5'><titre>Kiki la petite sorcière</titre><realisateur>Hayao Miyazaki</realisateur><date>1989</date></film><film idfilm='6'><titre>La reine des neiges</titre><realisateur>Disney</realisateur><date>2013</date></film></films>";
        
        var http = new XMLHttpRequest(); 
        http.open("GET", "mesfilms.xml", true);
        
        let response = this.responseText;
        console.log(response);

        function getEasyXML()
        {
            var parser = new DOMParser(); 
            var xmldoc = parser.parseFromString(string, "text/html");
            document.getElementById("areaXML").innerHTML = xmldoc.getElementsByTagName("films");
             
            let titres = xmldoc.getElementsByTagName("titre"); 
            let lestitres = "" 
            let lesdates = ""; 
            let lesreals = ""; 
            let reals = xmldoc.getElementsByTagName("realisateur"); 
            let dates = xmldoc.getElementsByTagName("date"); 

            let lefilm = ""; 
            let lereal = ""; 
            let ladate = "";

            for(let index = 0; index < titres.length; index++)
            {
                lefilm = titres[index].innerHTML; 
                lestitres += "Titre : " + lefilm + "\n"; 

                lereal = reals[index].innerHTML; 
                lesreals += "Realisateurs : " + lereal + "\n";

                ladate = dates[index].innerHTML; 
                lesdates += "Date : " + ladate + "\n";  
            }   
            document.getElementById("areaTitres").innerHTML = lestitres;
            document.getElementById("areaReals").innerHTML = lesreals; 
            document.getElementById("areaDates").innerHTML = lesdates; 
            }


        function GetXML()
        {
            console.log("chargement");
            console.log(http.readyState == 4);
            console.log(http.status == 200);
            http.onreadystatechange = function()
            {
                if(http.readyState == 4 && http.status == 200)
                {
                    let parser = new DOMParser();
                    XMLDoc = parser.parseFromString(this.responseText, "text/html"); 


                    let titres = XMLDoc.getElementsByTagName("titre"); 
                    console.log(titres);
                    let lestitres = "" 
                    let lesdates = ""; 
                    let lesreals = ""; 
                    let reals = XMLDoc.getElementsByTagName("realisateur"); 
                    console.log(reals);
                    let dates = XMLDoc.getElementsByTagName("date"); 
                    console.log(dates);

                    let lefilm = ""; 
                    let lereal = ""; 
                    let ladate = "";

                    for(let index = 0; index < titres.length; index++)
                    {
                        lefilm = titres[index].innerHTML; 
                        lestitres += "Titre : " + lefilm + "\n"; 
                        console.log(lefilm);

                        lereal = reals[index].innerHTML; 
                        lesreals += "Realisateurs : " + lereal + "\n";
                        console.log(lereal);

                        ladate = dates[index].innerHTML; 
                        lesdates += "Date : " + ladate + "\n";  
                        console.log(ladate)
                    }   
                    document.getElementById("areaTitres").innerHTML = lestitres;
                    document.getElementById("areaReals").innerHTML = lesreals; 
                    document.getElementById("areaDates").innerHTML = lesdates; 
                }
            }
        }
       
        http.send(); 
        </script>
    </body>
</html>